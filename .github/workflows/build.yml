name: Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags starting with v (e.g., v0.1.0)
  workflow_dispatch: # Allow manual triggering

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-20.04
            artifact_name: Lexiclip-Linux.AppImage
            asset_name: Lexiclip-Linux-x86_64.AppImage
            
          - os: windows-latest
            artifact_name: Lexiclip.exe
            asset_name: Lexiclip-Windows-x64.exe
            
          - os: macos-latest
            artifact_name: Lexiclip.app
            asset_name: Lexiclip-macOS.zip

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Linux specific setup for AppImage
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 file wget python3-venv libgl1-mesa-glx libglib2.0-0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # Build for Linux (AppImage)
      - name: Build Linux AppImage
        if: runner.os == 'Linux'
        run: |
          # Use the existing build script logic but adapted for CI
          pyinstaller PlasmaOCR.spec
          
          # Prepare AppDir
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          cp -r dist/PlasmaOCR AppDir/usr/bin/
          cp assets/icons/app_icon.svg AppDir/usr/share/icons/hicolor/256x256/apps/lexiclip.svg
          cp assets/icons/app_icon.svg AppDir/lexiclip.svg
          
          # Create Desktop file
          cat > AppDir/lexiclip.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Lexiclip OCR
          Exec=PlasmaOCR/PlasmaOCR
          Icon=lexiclip
          Categories=Utility;
          Terminal=false
          EOF
          
          # Create AppRun
          cat > AppDir/AppRun <<EOF
          #!/bin/sh
          HERE="\$(dirname "\$(readlink -f "\${0}")")"
          export PATH="\${HERE}/usr/bin/PlasmaOCR:\${PATH}"
          export LD_LIBRARY_PATH="\${HERE}/usr/lib:\${LD_LIBRARY_PATH}"
          exec "\${HERE}/usr/bin/PlasmaOCR/PlasmaOCR" "\$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Download appimagetool
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          # Build AppImage with --appimage-extract-and-run to avoid FUSE issues in CI
          ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir ${{ matrix.asset_name }}

      # Build for Windows
      - name: Build Windows Executable
        if: runner.os == 'Windows'
        run: |
          pyinstaller PlasmaOCR.spec

      # Build for macOS
      - name: Build macOS App
        if: runner.os == 'macOS'
        run: |
          pyinstaller PlasmaOCR.spec
          # Zip the .app bundle for uploading
          cd dist
          zip -r ../${{ matrix.asset_name }} LexiclipOCR.app

      # Upload Artifacts (Internal use for next job)
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ runner.os == 'Linux' && matrix.asset_name || '' }}
            ${{ runner.os == 'Windows' && 'dist/PlasmaOCR.exe' || '' }}
            ${{ runner.os == 'Windows' && 'dist/PlasmaOCR' || '' }} -- Note: onefolder build on Windows needs zipping too usually, assuming spec is onefile? 
            ${{ runner.os == 'macOS' && matrix.asset_name || '' }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            */Lexiclip-Linux-x86_64.AppImage
            */Lexiclip-macOS.zip
            */Lexiclip-Windows-x64.exe # Need to verify exact path
          draft: false
          prerelease: false
          generate_release_notes: true
